<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="add.title">Ajouter une m√©daille</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/i18n.js" defer></script>
</head>
<body class="bg-gradient-to-b from-black via-gray-900 to-gray-800 text-white">

  <!-- Navbar -->
  <header class="bg-black border-b border-gray-700 p-4 flex justify-between items-center">
    <a href="/" class="text-xl font-bold text-gray-200" data-i18n="app.title">Medaldex</a>
    <div class="flex gap-2">
      <select id="langSwitcher" class="bg-gray-800 text-gray-200 border border-gray-600 rounded p-1">
        <option value="fr">üá´üá∑ FR</option>
        <option value="en">üá¨üáß EN</option>
      </select>
      <button id="logoutBtn" class="bg-gray-800 text-gray-200 px-4 py-2 rounded" data-i18n="buttons.logout">D√©connexion</button>
    </div>
  </header>

  <!-- Formulaire d'ajout -->
  <main class="container mx-auto py-12 px-6 max-w-lg">
    <h1 class="text-3xl font-bold mb-6" data-i18n="add.title">Ajouter une m√©daille</h1>
    <form id="medalForm" class="space-y-4">
      <input id="name" type="text" data-i18n-placeholder="add.name" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
      <input id="country" type="text" data-i18n-placeholder="add.country" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
      <input id="year" type="number" data-i18n-placeholder="add.year" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
      
      <select id="type" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
        <option value="military" data-i18n="filters.types.military">Militaire / Paramilitaire</option>
        <option value="civil" data-i18n="filters.types.civil">Civil / Politique</option>
      </select>

      <select id="state" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
        <option value="new" data-i18n="filters.states.new">Neuf</option>
        <option value="vg" data-i18n="filters.states.vg">Tr√®s bon √©tat</option>
        <option value="good" data-i18n="filters.states.good">Bon</option>
        <option value="fair" data-i18n="filters.states.fair">Moyen</option>
        <option value="poor" data-i18n="filters.states.poor">Us√©</option>
      </select>

      <textarea id="description" data-i18n-placeholder="add.description" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></textarea>
      
      <input id="image" type="file" accept="image/*" class="w-full p-2 rounded bg-gray-800 border border-gray-600">

      <button type="submit" class="w-full bg-gray-200 text-black py-2 rounded font-semibold" data-i18n="add.submit">Enregistrer</button>
    </form>
  </main>

  <!-- Script Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "/config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // V√©rifier l'utilisateur connect√©
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = "/login/";
    }

    // D√©connexion
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "/login/";
    });

    // Gestion du formulaire
    document.getElementById("medalForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const country = document.getElementById("country").value;
      const year = document.getElementById("year").value;
      const type = document.getElementById("type").value;
      const state = document.getElementById("state").value;
      const description = document.getElementById("description").value;
      const file = document.getElementById("image").files[0];

      let imageUrl = null;
      if (file) {
        // Upload image dans Supabase Storage (bucket "medals" √† cr√©er)
        const filePath = `${user.id}/${Date.now()}-${file.name}`;
        const { error: uploadError } = await supabase.storage
          .from("medals")
          .upload(filePath, file);

        if (uploadError) {
          alert("Erreur upload image: " + uploadError.message);
          return;
        }

        // R√©cup√©rer l'URL publique
        const { data } = supabase.storage.from("medals").getPublicUrl(filePath);
        imageUrl = data.publicUrl;
      }

      // Ins√©rer la m√©daille en BDD
      const { error } = await supabase.from("medals").insert([{
        user_id: user.id,
        name,
        country,
        year,
        type,
        state,
        description,
        image_url: imageUrl
      }]);

      if (error) {
        alert("‚ùå Erreur ajout m√©daille: " + error.message);
      } else {
        alert("‚úÖ M√©daille ajout√©e !");
        window.location.href = "/collection/";
      }
    });
  </script>
</body>
</html>
